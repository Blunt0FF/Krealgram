<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
        }
        .file-info {
            background: #f5f5f5;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: red;
            background: #ffe6e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            background: #e6ffe6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input[type="file"] {
            display: none;
        }
        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }
        .file-input-label:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</h1>
    
    <div class="upload-section">
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <label class="file-input-label">
            üì∏ –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
            <input type="file" id="fileInput" accept="image/*,video/*,.heic,.heif" />
        </label>
        
        <div id="fileInfo" class="file-info" style="display: none;"></div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>
        
        <button id="testButton" style="display: none;">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É</button>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const error = document.getElementById('error');
        const success = document.getElementById('success');
        const testButton = document.getElementById('testButton');
        
        let selectedFile = null;

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            selectedFile = file;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
            fileInfo.innerHTML = `
                <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ:</strong><br>
                –ò–º—è: ${file.name}<br>
                –¢–∏–ø: ${file.type}<br>
                –†–∞–∑–º–µ—Ä: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                –ü–æ—Å–ª–µ–¥–Ω–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: ${new Date(file.lastModified).toLocaleString()}<br>
                –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ: ${file.name.split('.').pop().toLowerCase()}
            `;
            fileInfo.style.display = 'block';
            error.style.display = 'none';
            success.style.display = 'none';
            testButton.style.display = 'inline-block';
        });

        testButton.addEventListener('click', async () => {
            if (!selectedFile) return;

            error.style.display = 'none';
            success.style.display = 'none';
            
            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞
                const result = await processFile(selectedFile);
                success.innerHTML = `‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!<br>–†–µ–∑—É–ª—å—Ç–∞—Ç: ${result}`;
                success.style.display = 'block';
            } catch (err) {
                error.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${err.message}`;
                error.style.display = 'block';
            }
        });

        async function processFile(file) {
            return new Promise((resolve, reject) => {
                console.log('üîß –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞:', file.name);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
                const isImage = file.type.startsWith('image/');
                const isVideo = file.type.startsWith('video/');
                const isHeic = file.type === 'image/heic' || file.type === 'image/heif' || 
                              file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');
                
                if (!isImage && !isVideo) {
                    reject(new Error('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞'));
                    return;
                }

                if (isVideo) {
                    // –î–ª—è –≤–∏–¥–µ–æ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–æ–∂–µ–º —Å–æ–∑–¥–∞—Ç—å URL
                    const videoUrl = URL.createObjectURL(file);
                    resolve(`–í–∏–¥–µ–æ —Ñ–∞–π–ª –≥–æ—Ç–æ–≤ –∫ –∑–∞–≥—Ä—É–∑–∫–µ (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
                    return;
                }

                if (isHeic) {
                    // –î–ª—è HEIC —Ñ–∞–π–ª–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
                    resolve(`HEIC —Ñ–∞–π–ª –æ–±–Ω–∞—Ä—É–∂–µ–Ω - —Ç—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ JPEG`);
                    return;
                }

                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–µ—Å—Ç–∏—Ä—É–µ–º —Å–∂–∞—Ç–∏–µ
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                img.onload = () => {
                    try {
                        console.log('üîß Image loaded:', {
                            naturalWidth: img.naturalWidth,
                            naturalHeight: img.naturalHeight,
                            width: img.width,
                            height: img.height
                        });

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
                        if (img.naturalWidth === 0 || img.naturalHeight === 0) {
                            reject(new Error('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–º–µ–µ—Ç –Ω—É–ª–µ–≤—ã–µ —Ä–∞–∑–º–µ—Ä—ã'));
                            return;
                        }

                        canvas.width = img.naturalWidth;
                        canvas.height = img.naturalHeight;
                        
                        // –û—á–∏—â–∞–µ–º canvas
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                        
                        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
                        const tryFormats = [
                            { format: 'image/jpeg', quality: 0.8 },
                            { format: 'image/jpeg', quality: 0.6 },
                            { format: 'image/png', quality: 0.8 }
                        ];

                        let attempt = 0;
                        const tryNextFormat = () => {
                            if (attempt >= tryFormats.length) {
                                reject(new Error('–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ —Å–∂–∞—Ç–∏—è –Ω–µ —É–¥–∞–ª–∏—Å—å'));
                                return;
                            }

                            const { format, quality } = tryFormats[attempt];
                            console.log(`üîß –ü–æ–ø—ã—Ç–∫–∞ ${attempt + 1}: ${format} —Å –∫–∞—á–µ—Å—Ç–≤–æ–º ${quality}`);
                            
                            canvas.toBlob((blob) => {
                                if (blob && blob.size > 0) {
                                    const compressedSize = (blob.size / 1024 / 1024).toFixed(2);
                                    const compressionRatio = ((blob.size / file.size) * 100).toFixed(1);
                                    resolve(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∂–∞—Ç–æ (${format}): ${compressedSize} MB (${compressionRatio}% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)`);
                                } else {
                                    attempt++;
                                    tryNextFormat();
                                }
                            }, format, quality);
                        };

                        tryNextFormat();
                    } catch (err) {
                        reject(new Error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${err.message}`));
                    }
                };
                
                img.onerror = (error) => {
                    console.error('‚ùå Image load error:', error);
                    reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'));
                };
                
                try {
                    const objectUrl = URL.createObjectURL(file);
                    img.src = objectUrl;
                    
                    // –û—á–∏—â–∞–µ–º URL –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                    const originalOnLoad = img.onload;
                    img.onload = () => {
                        URL.revokeObjectURL(objectUrl);
                        if (originalOnLoad) {
                            originalOnLoad.call(img);
                        }
                    };
                } catch (error) {
                    reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å URL –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è'));
                }
            });
        }
    </script>
</body>
</html> 