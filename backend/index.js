const express = require('express');
const mongoose = require('mongoose');
const dotenv = require('dotenv');
const cors = require('cors');
const path = require('path'); // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ¼ path Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ¿ÑƒÑ‚ÑĞ¼Ğ¸ Ğº ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼
const http = require('http');
const { Server } = require('socket.io');
const connectDB = require('./config/db'); // ĞœÑ‹ ÑĞ¾Ğ·Ğ´Ğ°Ğ´Ğ¸Ğ¼ ÑÑ‚Ğ¾Ñ‚ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ°Ğ»ĞµĞµ
const { startUserStatusUpdater } = require('./utils/userStatusUpdater');
const { resetAllUsersToOffline } = require('./utils/resetUserStatuses');

// Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
dotenv.config();

console.log('[SERVER] ğŸš€ Starting Krealgram backend...');

// ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ÑÑ Ğº MongoDB
connectDB();

// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Google Drive Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾, Ğ½Ğ¾ Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ Ğ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²ĞµÑ€Ğ°
const googleDrive = require('./config/googleDrive');
googleDrive.initialize().then(() => {
  console.log('[SERVER] âœ… Google Drive initialization completed');
}).catch((error) => {
  console.error('[SERVER] âŒ Google Drive initialization failed:', error.message);
  console.log('[SERVER] âš ï¸ Server will continue without Google Drive');
});

const app = express();
const server = http.createServer(app);
const io = new Server(server, {
  cors: {
    origin: [
      "http://localhost:4000",
      "http://127.0.0.1:4000",
      "https://krealgram.vercel.app",
      "https://krealgram.com",
      "https://www.krealgram.com"
    ],
    methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"],
    credentials: true
  }
});

app.set('io', io); // Ğ¡Ğ´ĞµĞ»Ğ°ĞµĞ¼ io Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğ¼ Ğ² ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€Ğ°Ñ…

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ CORS Ğ´Ğ»Ñ Express
const whitelist = [
  "http://localhost:4000",
  "http://127.0.0.1:4000",
  "https://krealgram.vercel.app",
  "https://krealgram.com",
  "https://www.krealgram.com"
];
const corsOptions = {
  origin: (origin, callback) => {
    // Ğ Ğ°Ğ·Ñ€ĞµÑˆĞ°ĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ±ĞµĞ· origin (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ñ Ğ¼Ğ¾Ğ±Ğ¸Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¹ Ğ¸Ğ»Ğ¸ curl)
    // Ğ¸Ğ»Ğ¸ ĞµÑĞ»Ğ¸ Ğ¸ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ² Ğ±ĞµĞ»Ğ¾Ğ¼ ÑĞ¿Ğ¸ÑĞºĞµ.
    if (!origin || whitelist.includes(origin)) {
      callback(null, true);
    } else {
      callback(new Error('Not allowed by CORS'));
    }
  },
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization', 'X-Requested-With', 'Accept', 'Origin'],
  exposedHeaders: ['Content-Range', 'X-Content-Range'],
  credentials: true,
  maxAge: 86400 // 24 Ñ‡Ğ°ÑĞ°
};

// Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ OPTIONS-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ².
// Ğ­Ñ‚Ğ¾ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ´Ğ»Ñ "Ğ½ĞµĞ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ…" Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ² (POST, PUT, DELETE Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¼Ğ¸ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ°Ğ¼Ğ¸),
// ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±ÑƒÑÑ‚ preflight-Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¾Ñ‚ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğ°.
app.options('*', cors(corsOptions));

app.use(cors(corsOptions));

// Ğ’Ğ°Ğ¶Ğ½Ğ¾: middleware Ğ´Ğ»Ñ Ğ¿Ğ°Ñ€ÑĞ¸Ğ½Ğ³Ğ° JSON Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ´Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ»Ğµ CORS
app.use(express.json({ limit: '50mb' })); // Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ¼ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚ Ğ´Ğ»Ñ base64 Ğ°Ğ²Ğ°Ñ‚Ğ°Ñ€Ğ¾Ğ² Ğ¸ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
app.use(express.urlencoded({ limit: '50mb', extended: true }));

// Ğ Ğ°Ğ·Ğ´Ğ°Ñ‡Ğ° ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¸Ğ· Ğ¿Ğ°Ğ¿ĞºĞ¸ 'uploads'
// __dirname Ğ² ES Modules Ğ½Ğµ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ‚Ğ°Ğº, ĞºĞ°Ğº Ğ² CommonJS, Ğ½Ğ¾ Ñ‚Ğ°Ğº ĞºĞ°Ğº package.json ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ "type": "commonjs" (Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ npm init -y)
// Ñ‚Ğ¾ __dirname Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾.
// Ğ•ÑĞ»Ğ¸ Ğ±Ñ‹ Ğ¼Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ»Ğ¸ "type": "module", Ğ¿Ñ€Ğ¸ÑˆĞ»Ğ¾ÑÑŒ Ğ±Ñ‹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ import.meta.url
app.use('/uploads', express.static(path.join(__dirname, 'uploads')));

// Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
app.get('/', (req, res) => {
  res.send('Krealgram API is working!');
});

// Health check endpoint
app.get('/api/health', (req, res) => {
  res.status(200).json({
    status: 'OK',
    message: 'Server is running',
    timestamp: new Date().toISOString()
  });
});

// TODO: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ (routes)
const authRoutes = require('./routes/authRoutes');
const postRoutes = require('./routes/postRoutes');
const userRoutes = require('./routes/userRoutes');
const commentRoutes = require('./routes/commentRoutes');
const searchRoutes = require('./routes/searchRoutes');
const likeRoutes = require('./routes/likeRoutes');
const conversationRoutes = require('./routes/conversationRoutes'); // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²
const notificationRoutes = require('./routes/notificationRoutes'); // Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
const adminRoutes = require('./routes/adminRoutes'); // ĞĞ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹

app.use('/api/auth', authRoutes);
app.use('/api/posts', postRoutes);
app.use('/api/users', userRoutes);
app.use('/api/comments', commentRoutes);
app.use('/api/search', searchRoutes);
app.use('/api/likes', likeRoutes);
app.use('/api/conversations', conversationRoutes); // ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²
app.use('/api/notifications', notificationRoutes); // ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹ Ğ´Ğ»Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
app.use('/api/admin', adminRoutes); // ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğµ Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ñ‹

// ĞŸÑ€Ğ¾ĞºÑĞ¸-ÑĞ½Ğ´Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ Ğ´Ğ»Ñ Google Drive
app.get('/api/proxy-drive/:id', async (req, res) => {
  const fileId = req.params.id;
  const { google } = require('googleapis');
  const drive = require('./config/googleDrive');

  try {
    console.log(`[PROXY-DRIVE] Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° Ğ¿Ñ€Ğ¾ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° ${fileId}`);
    if (!drive.isInitialized) {
      console.error('[PROXY-DRIVE] Google Drive Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½');
      return res.status(500).send('Google Drive not initialized');
    }

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ°
    const meta = await drive.drive.files.get({
      fileId,
      fields: 'name, mimeType'
    });
    const mimeType = meta.data.mimeType || 'application/octet-stream';
    const fileName = meta.data.name || 'file';
    console.log(`[PROXY-DRIVE] mimeType: ${mimeType}, fileName: ${fileName}`);

    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ°Ğ¼ Ñ„Ğ°Ğ¹Ğ» ĞºĞ°Ğº stream
    const fileRes = await drive.drive.files.get({
      fileId,
      alt: 'media'
    }, { responseType: 'stream' });

    res.setHeader('Content-Type', mimeType);
    res.setHeader('Content-Disposition', `inline; filename="${fileName}"`);
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Cache-Control', 'public, max-age=31536000');

    fileRes.data.on('end', () => {
      console.log(`[PROXY-DRIVE] Ğ¤Ğ°Ğ¹Ğ» ${fileId} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ½Ğ° Ñ„Ñ€Ğ¾Ğ½Ñ‚`);
    });
    fileRes.data.on('error', (err) => {
      console.error('[PROXY-DRIVE] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ñ„Ğ°Ğ¹Ğ»Ğ°:', err);
      res.status(500).send('Error streaming file');
    });
    fileRes.data.pipe(res);
  } catch (err) {
    if (err.message && err.message.includes('File not found')) {
      console.warn(`[PROXY-DRIVE] âš ï¸ Ğ¤Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½: ${fileId}`);
      return res.status(404).send('File not found');
    }
    console.error('[PROXY-DRIVE] âŒ ĞÑˆĞ¸Ğ±ĞºĞ°:', err.message);
    res.status(500).send('Proxy error: ' + err.message);
  }
});

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Socket.IO
io.on('connection', async (socket) => {
  // ĞŸÑ€Ğ¸ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ğµ Ğº ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğµ Ğ¿Ğ¾ userId
  const userId = socket.handshake.query.userId;
  if (userId) {
    socket.join(userId);

    // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ĞºĞ°Ğº Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½
    try {
      const User = require('./models/userModel');
      await User.findByIdAndUpdate(userId, {
        isOnline: true,
        lastActive: new Date()
      });
    } catch (error) {
      console.error('Error updating user online status:', error);
    }
  }

  socket.on('disconnect', async () => {
    // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ĞºĞ°Ğº Ğ¾Ñ„Ñ„Ğ»Ğ°Ğ¹Ğ½ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸
    if (userId) {
      try {
        const User = require('./models/userModel');
        await User.findByIdAndUpdate(userId, {
          isOnline: false,
          lastActive: new Date()
        });
      } catch (error) {
        console.error('Error updating user offline status:', error);
      }
    }
  });
});

const PORT = process.env.PORT || 3000;

// Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµÑ… Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ğ² offline Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞºĞµ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
resetAllUsersToOffline().then(() => {
  // console.log('All users set to offline on server start');
}).catch((error) => {
  console.error('Failed to reset user statuses:', error);
});

// Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
startUserStatusUpdater();

server.listen(PORT, () => {
  console.log(`[SERVER] âœ… Server running on port ${PORT}`);
  if (Array.isArray(corsOptions.origin)) {
    console.log(`[SERVER] ğŸŒ CORS origins: ${corsOptions.origin.join(', ')}`);
  } else {
    console.log(`[SERVER] ğŸŒ CORS origins: ${corsOptions.origin}`);
  }
  console.log(`[SERVER] ğŸ“¡ Socket.IO ready`);
  console.log(`[SERVER] ğŸ”— Health check: http://localhost:${PORT}/api/health`);
}); 