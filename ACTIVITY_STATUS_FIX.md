# Исправление проблемы с отображением статуса активности

## Проблема
Все пользователи отображаются как "Active now" (онлайн), что неверно.

## Причина
В предыдущей версии кода `authMiddleware.js` устанавливал `isOnline = true` при каждом API запросе, что делало всех пользователей "онлайн".

## Исправления

### 1. Обновлена логика статусов
- `authMiddleware.js` - теперь обновляет только `lastActive`, но не `isOnline`
- `authController.js` (login) - не устанавливает `isOnline = true`
- Статус `isOnline` управляется только через WebSocket подключения

### 2. Добавлены новые утилиты
- `utils/userStatusUpdater.js` - автоматически устанавливает пользователей offline если неактивны >5 минут
- `utils/resetUserStatuses.js` - сброс всех пользователей в offline
- `routes/adminRoutes.js` - административные API для управления статусами

### 3. Сброс статусов при запуске сервера
Сервер автоматически сбрасывает всех пользователей в offline при запуске.

## Как исправить сейчас

### Способ 1: Перезапустить сервер
```bash
# Остановить сервер (Ctrl+C)
# Запустить заново
npm start
```

### Способ 2: Использовать API сброса
```bash
# Сбросить всех пользователей в offline
curl -X POST http://localhost:3000/api/admin/reset-user-statuses

# Проверить статистику
curl http://localhost:3000/api/admin/user-statuses
```

### Способ 3: Обновить неактивных пользователей
```bash
curl -X POST http://localhost:3000/api/admin/update-inactive-users
```

## Новая логика работы

1. **При подключении WebSocket** - пользователь становится онлайн
2. **При отключении WebSocket** - пользователь становится офлайн  
3. **Каждые 2 минуты** - автоматическая проверка неактивных >5 минут
4. **При выходе через logout** - пользователь становится офлайн
5. **При API запросах** - обновляется только `lastActive`

## Проверка исправления

После перезапуска сервера:
- Должны быть видны только действительно активные пользователи
- Статус должен корректно обновляться при подключении/отключении
- Через 5+ минут неактивности пользователи должны стать офлайн 