# Устранение неполадок Krealgram

## Проблемы с загрузкой изображений

### Ошибка "Error processing file. Please try again."

**Причины:**
1. Превышение лимита памяти на сервере
2. CORS ошибки
3. Проблемы с обработкой больших файлов

**Решения:**

#### 1. Оптимизация памяти
- Уменьшен лимит размера файла до 50MB
- Добавлен мониторинг памяти
- Принудительная очистка памяти после обработки

#### 2. Исправление CORS
- Добавлена поддержка всех доменов krealgram.com
- Улучшена обработка preflight запросов
- Добавлены дополнительные заголовки

#### 3. Обработка ошибок
- Добавлена проверка памяти перед обработкой
- Улучшена обработка ошибок загрузки
- Автоматическая очистка временных файлов

## Проблемы с производительностью

### "Failed to fetch" и падение рендера

**Причины:**
1. Превышение лимита памяти на Render
2. Неэффективная обработка изображений
3. Отсутствие мониторинга ресурсов

**Решения:**

#### 1. Мониторинг памяти
```javascript
// Автоматический мониторинг каждые 30 секунд
memoryMonitor.startMonitoring(30000);
```

#### 2. Оптимизация изображений
- Уменьшение размера thumbnail до 200x200
- Сжатие качества до 60%
- Ленивая загрузка превью

#### 3. Обработка ошибок
- Проверка памяти перед обработкой
- Принудительная очистка после операций
- Graceful degradation при ошибках

## Настройки для Render

### Переменные окружения
```bash
NODE_OPTIONS="--max-old-space-size=512"
```

### Мониторинг ресурсов
- Логирование использования памяти
- Автоматическая очистка
- Предупреждения о превышении лимитов

## Рекомендации по использованию

### Для пользователей
1. Сжимайте изображения перед загрузкой
2. Используйте форматы JPEG/PNG
3. Избегайте файлов больше 50MB

### Для разработчиков
1. Мониторьте логи памяти
2. Проверяйте CORS настройки
3. Тестируйте с большими файлами

## Логи и диагностика

### Ключевые логи
- `[MEMORY_MONITOR]` - информация о памяти
- `[CORS_DEBUG]` - CORS запросы
- `[POST_ROUTE_ERROR]` - ошибки создания постов

### Мониторинг в реальном времени
```bash
# Просмотр логов
tail -f logs/app.log

# Проверка памяти
curl -X GET https://krealgram-backend.onrender.com/api/health
```

## Обновления и исправления

### Последние изменения
1. ✅ Исправлены CORS ошибки
2. ✅ Добавлен мониторинг памяти
3. ✅ Оптимизирована обработка изображений
4. ✅ Улучшена обработка ошибок

### Планируемые улучшения
1. Кэширование изображений
2. CDN для статических файлов
3. Автоматическое масштабирование 